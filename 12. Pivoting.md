# Task 10 : Pivoting Proxychains & Foxyproxy

> [!Note]
> There is one other line in the Proxychains configuration that is worth paying attention to, specifically related to the Proxy DNS settings:
Screenshot showing the proxy_dns line in the Proxychains config

If performing an Nmap scan through proxychains, this option can cause the scan to hang and ultimately crash. Comment out the `proxy_dns` line using a hashtag (`#`) at the start of the line before performing a scan through the proxy!

> SOCKS4 is usually a good bet, although Chisel (which we will cover in a later task) requires SOCKS5. 

# SSH Tunneling

**There are three main types of SSH tunnels:**

## Local Port Forwarding:

[Guide to Using SSH Port Forwarding (SSH Tunneling)](https://builtin.com/software-engineering-perspectives/ssh-port-forwarding#:~:text=SSH%20port%20forwarding.-,Local%20Port%20Forwarding%3A%20Redirects%20traffic%20from%20a%20local%20port%20on,external%20access%20to%20local%20services.)

ssh -L [local_port]:[destination_address]:[destination_port] [username]@[ssh_server]

```sh
> Command:
ssh -L 8080:192.168.1.100:80 user@remote_server
```


```sh
ssh -L [bind_address:]port:host:hostport -N -f username@remotehost
ssh -L [bind_address:]port:remote_socket -N -f username@remotehost
ssh -L local_socket:host:hostport -N -f username@remotehost
ssh -L local_socket:remote_socket -N -f username@remotehost

ssh -L 3307:localhost:3306 -N -f root@remotehost
```

## Remote Port Forwarding:

ssh -R [remote_port]:[destination_address]:[local_port] [username]@[ssh_server]

```
> Command:
ssh -R 80:192.168.1.10:8080 user@123.45.67.89
```

```sh
ssh -R [bind_address:]port:host:hostport -N -f username@remotehost
ssh -R [bind_address:]port:local_socket -N -f username@remotehost
ssh -R remote_socket:host:hostport -N -f username@remotehost
ssh -R remote_socket:local_socket -N -f username@remotehost
ssh -R [bind_address:]port -N -f username@remotehost

ssh -R 8080:localhost:8081 -N -f root@remotehost
```

## Dynamic Port Forwarding (SOCKS Proxy):

```sh
ssh -D [bind_address:]port -N -f username@remotehost

ssh -D 9090 -N -f root@remotehost
```
> SSH Tunneling: https://www.linkedin.com/pulse/ssh-tunneling-dhaval-gajjar/

---

# What's ssh port forwarding and what's the difference between ssh local and remote port forwarding [duplicate]

https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot

---

## Local Port forwarding

ssh creates an additional local port which it will forward to a port on the remote system.

> example

```
ssh -L 8080:127.0.0.1:80 user@webserver
```

Then in your browser on local use URL http://localhost:8080/

it will connect to local machines port 8080, which ssh will forward on to remote ssh, and it will then make a request to 127.0.0.1:80. Note 127.0.0.1 is actually the remote server's localhost, but it could have been a host/IP available at the remote machine's network.

## Remote forward

Asks ssh to create a listening port on the remote machine which it will forward back (Reverse) to the local ssh to forward on.

```
ssh -R 10123:127.0.0.1:123 user@webserver
```

So, after ssh connects to webserver, the remote ssh creates and lsitens on a port 10123. A process on webserver connecting to 10123, ssh will pick it up and send it back to the local machine's ssh, which sends it on to 127.0.01:123 port.


---
## I have drawn some sketches

### ssh tunnel starting from local
![local-port-frd](https://github.com/khansiddique/pentesting-repo-notes/blob/main/Images/local-port-frd-a28N8.png)

### ssh tunnel starting from remote
![remote-port-frd](https://github.com/khansiddique/pentesting-repo-notes/blob/main/Images/remote-port-frd-4iK3b.png)

## Introduction

local: `-L Specifies that the given port on the local (client) host is to be forwarded to the given host and port on the remote side.`

`ssh -L sourcePort:forwardToHost:onPort connectToHost` means: connect with ssh to `connectToHost`, and forward all connection attempts to the **local** `sourcePort` to port `onPort` on the machine called `forwardToHost`, which can be reached from the `connectToHost` machine.

remote: `-R Specifies that the given port on the remote (server) host is to be forwarded to the given host and port on the local side.`

`ssh -R sourcePort:forwardToHost:onPort connectToHost` means: connect with ssh to `connectToHost`, and forward all connection attempts to the **remote** `sourcePort` to port `onPort` on the machine called `forwardToHost`, which can be reached from your local machine.

### Examples

> Example for 1

```
ssh -L 80:localhost:80 SUPERSERVER
```
You specify that a connection made to the local port 80 is to be forwarded to port 80 on SUPERSERVER. That means if someone connects to your computer with a webbrowser, he gets the response of the webserver running on SUPERSERVER. You, on your local machine, have no webserver running.

> Example for 2

```
ssh -R 80:localhost:80 tinyserver
```

You specify, that a connection made to the port 80 of tinyserver is to be forwarded to port 80 on your local machine. That means if someone connects to the small and slow server with a webbrowser, he gets the response of the webserver running on your local machine. The tinyserver, which has not enough diskspace for the big website, has no webserver running. But people connecting to tinyserver think so.

### More examples
Other things could be: The powerful machine has five webservers running on five different ports. If a user connects to one of the five tinyservers at port 80 with his webbrowser, the request is redirected to the corresponding webserver running on the powerful machine. That would be

```
ssh -R 80:localhost:30180 tinyserver1
ssh -R 80:localhost:30280 tinyserver2
etc.
```

Or maybe your machine is only the connection between the powerful and the small servers. Then it would be (for one of the tinyservers that play to have their own webservers):

```
ssh -R 80:SUPERSERVER:30180 tinyserver1
ssh -R 80:SUPERSERVER:30280 tinyserver2
etc
```

---

# Local vs Remote Port forwarding
https://www.reddit.com/r/AskNetsec/comments/pvqhr9/local_vs_remote_port_forwarding/


A local port forward will reroute traffic destined to a port on the machine MAKING the connection, to a port on the machine RECEIVING the connection. For example. 
`ssh [remoteuser]@[remotehost] -L 1234:localhost:5678`
will bind port 1234 on your machine to port 5678 on the remote machine. So if you have a service listening on 5678 you can interact with it at `127.0.0.1:1234`.

Remote port forwards are the same thing, but the connection is going the other direction so it can be useful in a different way. It's still in the format `sourceport:host:destinationport` but instead if the source port being on the local machine, the source port is on the machine you're connecting to. Imagine you have a SSH listener on your computer that's publicly routable (not recommended without more security controls in place) and a host that `you want to connect to on another network that's behind a firewall`. You have physical access to the firewalled host. You can do, from that host, 
`ssh [youruser]@[yourhost] -R 2222:localhost:22` 
where yourhost is your public address. Then, from your machine you can do 
`ssh [remoteuser]@127.0.0.1:2222` and the connection will traverse the SSH tunnel you've built so you're connecting directly to the remote machine by targeting a port on your computer.

---

# Reference:

### Tryhackme Room
- lateralmovementandpivoting: https://tryhackme.com/r/room/lateralmovementandpivoting
- wreath: https://tryhackme.com/r/room/wreath


---

**Tunneling and Port Forwarding: https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding**

> SSH Tunneling: https://www.linkedin.com/pulse/ssh-tunneling-dhaval-gajjar/

> SSH Port Forwarding for Hacking/Jumping: https://medium.com/@keaml/start-hacking-jumping-with-ssh-port-forwarding-59e1ee227d81
> 

### Blog:
1. Explore Hidden Networks With Double Pivoting : https://pentest.blog/explore-hidden-networks-with-double-pivoting/
2. How to Implement Pivoting and Relaying Techniques Using Meterpreter: https://medium.com/axon-technologies/how-to-implement-pivoting-and-relaying-techniques-using-meterpreter-b6f5ec666795
3. SSH Tunneling: https://www.linkedin.com/pulse/ssh-tunneling-dhaval-gajjar/
4. https://chamibuddhika.wordpress.com/tag/port-forwarding/
5. Use SSH Port Forwarding to connect to resources: https://faun.pub/use-ssh-port-forwarding-to-connect-to-resources-221534e9037
6. https://iximiuz.com/en/posts/ssh-tunnels/
7. SSH port forwarding visualized: http://dirk-loss.de/ssh-port-forwarding.htm
8. SSH Tunneling via a Jump Host: https://dev.to/claudiohigashi/ssh-tunneling-via-a-jump-host-2b5d
9. 

---

### Youtube: 

---

**TryHackMe Wreath Official Walkthrough, by [DarkSec](https://www.youtube.com/watch?v=UHU2GcA_hrY&list=PLsqUCyw0Jf9sMYXly0uuwfKMu34roGNwk&index=2)**

---
1. Home Lab: ProxyChains, eCPPT prep [OvergrownCarrot1 Hacking](https://www.youtube.com/watch?v=QNoIX1au_CM&t=4440s)
2. How To Pivot Through a Network with Chisel, by John Hammond:  https://www.youtube.com/watch?v=pbR_BNSOaMk
2. Master Network Pivoting, by Netsec Explained: https://www.youtube.com/playlist?list=PL8BogY0hWwvyjW51ZEhg3-n6HQHqYZLDO
3. Pivot Through Multiple Networks | Master Network Pivoting, by Netsec Explained: https://www.youtube.com/watch?v=Ik7ubJTILUw&list=PL8BogY0hWwvyjW51ZEhg3-n6HQHqYZLDO&index=7 
4. Lateral Movement and Pivoting | TryHackMe | Active Directory Series Part 4, by Anonymous World: https://www.youtube.com/watch?v=CODVHL1tmPA
5. [Arabic] pivoting exploit with Metasploit, by CTRL:  https://www.youtube.com/watch?v=iUb9wMknQ_U
6. Pivoting Entire Network with Chisel, by Tech69: https://www.youtube.com/watch?v=srUUUkcYEwg
7. Windows Manipulation: Lateral Movement & Pivoting Pt 1 / Windows Hacking PenTesting Tutorial by Hank Hackerson , https://www.youtube.com/watch?v=wWskSr4V07Y
8. Pivoting Introduction - eJPT lab, Ben Folland: https://www.youtube.com/watch?v=r7yuU7nvjSc
9. Network Pivoting with Ligolo-NG, by Gonski Cyber: https://www.youtube.com/watch?v=DM1B8S80EvQ
10. How Hackers Move Through Networks (with Ligolo), by John Hammond: https://www.youtube.com/watch?v=qou7shRlX_s
11. Webinar - Deep dive in double network Pivoting with Metasploit and ProxyChains by Empire Cybersecurity TV : https://www.youtube.com/watch?v=J-F_3PMbNGo&t=10s
12. Pivoting through multiple subnets with Ligolo by redfire359 : https://www.youtube.com/watch?v=LiaBVuz2B4o

---
### Tools:
PsExec v2.43: https://learn.microsoft.com/en-us/sysinternals/downloads/psexec

Should you be interested in more tools and techniques, the following resources are available:

- [Sshuttle](https://github.com/sshuttle/sshuttle)
- [Rpivot](https://github.com/klsecservices/rpivot)
- [Chisel](https://github.com/jpillora/chisel)
- [Hijacking Sockets with Shadowmove](https://adepts.of0x.cc/shadowmove-hijack-socket/)


---
### Port Forwarding & Tunneling

**Port Forwarding & Tunneling, by ryan_phdsec: https://www.youtube.com/watch?v=-yACoZ1ctHk**

1. SSH Tunneling - Local & Remote Port Forwarding (by Example) by Hussein Nasser : https://www.youtube.com/watch?v=N8f5zv9UUMI&t=14s
2. SSH Tunneling Explained by Tinkernut: https://www.youtube.com/watch?v=AtuAdk4MwWw

